<!DOCTYPE html>
<html>
<head>
    <title>GigConnect WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        #chat-window {
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }
        #chat-window img {
            max-width: 200px;
            max-height: 200px;
            display: block;
        }
    </style>
</head>
<body>
    <h1>GigConnect Real-Time Chat & Notification Tester</h1>
    <p>Open your browser's developer console (F12) to see connection status and incoming messages.</p>
    <hr>
    <div>
        <label for="userId">Your User ID:</label>
        <input type="text" id="userId" placeholder="Paste your User ID here...">
    </div>
    <div>
        <label for="jwtToken">Your JWT Token:</label>
        <input type="text" id="jwtToken" placeholder="Paste your JWT Token here..." style="width: 400px;">
    </div>
    <button onclick="connectAndSubscribe()">Connect & Subscribe</button>
    <button onclick="disconnect()">Disconnect</button>
    <hr>
    <div id="chat-window"></div>
    <div>
        <h3>Send a Message</h3>
        <label for="recipientId">Recipient User ID:</label>
        <input type="text" id="recipientId" placeholder="Paste recipient's User ID...">
        <br>
        <label for="messageContent">Message:</label>
        <input type="text" id="messageContent" placeholder="Type your message...">
        <button onclick="sendMessage()">Send Text</button>
        <br>
        <label for="file-upload">Share Media:</label>
        <input type="file" id="file-upload" accept="image/*,video/*">
        <button onclick="sendFile()">Send File</button>
    </div>
    <hr>
    <h2>Log:</h2>
    <div id="logs"></div>

    <script>
        let stompClient = null;
        const logs = document.getElementById('logs');
        const chatWindow = document.getElementById('chat-window');

        function log(message) {
            console.log(message);
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(p);
        }

        function displayMessage(message) {
            const p = document.createElement('p');
            if (message.content) {
                p.textContent = `From ${message.senderId}: ${message.content}`;
            } else if (message.mediaUrl) {
                const img = document.createElement('img');
                img.src = message.mediaUrl;
                p.textContent = `From ${message.senderId}: `;
                p.appendChild(img);
            }
            chatWindow.appendChild(p);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function connectAndSubscribe() {
            const userId = document.getElementById('userId').value;
            const jwtToken = document.getElementById('jwtToken').value;
            if (!userId || !jwtToken) {
                log("Error: Please enter your User ID and JWT Token.");
                return;
            }
            if (stompClient !== null) {
                log("Already connected. Please disconnect first.");
                return;
            }

            const socket = new SockJS('http://localhost:8081/ws');
            stompClient = Stomp.over(socket);

            const headers = {
                'Authorization': 'Bearer ' + jwtToken
            };

            stompClient.connect(headers, function (frame) {
                log('Successfully connected as user ' + userId);
                const privateQueue = '/user/' + userId + '/queue/messages';
                log('Subscribing to private chat queue: ' + privateQueue);
                stompClient.subscribe(privateQueue, function (message) {
                    const chatMessage = JSON.parse(message.body);
                    displayMessage(chatMessage);
                });

                const notificationTopic = '/topic/notifications/' + userId;
                log('Subscribing to notifications: ' + notificationTopic);
                stompClient.subscribe(notificationTopic, function (notification) {
                    const notificationBody = JSON.parse(notification.body);
                    log('Received Notification: ' + notificationBody.content);
                });

            }, function(error) {
                log('Connection Error: ' + error);
                stompClient = null;
            });
        }

        async function sendFile() {
            if (stompClient === null || !stompClient.connected) {
                log("Error: Not connected. Please connect first.");
                return;
            }
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            const recipientId = document.getElementById('recipientId').value;
            const jwtToken = document.getElementById('jwtToken').value;

            if (!file || !recipientId) {
                log("Error: Please select a file and enter a recipient.");
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                log("Uploading file to server...");
                const response = await fetch('http://localhost:8081/api/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`File upload failed with status: ${response.status}`);
                }

                const result = await response.json();
                const mediaUrl = result.secure_url;
                log(`File uploaded successfully. URL: ${mediaUrl}`);

                const chatMessage = {
                    senderId: document.getElementById('userId').value,
                    recipientId: recipientId,
                    mediaUrl: mediaUrl
                };

                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                displayMessage(chatMessage);
                log(`Sent media message to ${recipientId}`);
                fileInput.value = '';
            } catch (error) {
                log(`Error: ${error.message}`);
            }
        }

        function sendMessage() {
            if (stompClient === null || !stompClient.connected) {
                log("Error: Not connected. Please connect first.");
                return;
            }
            const senderId = document.getElementById('userId').value;
            const recipientId = document.getElementById('recipientId').value;
            const content = document.getElementById('messageContent').value;

            if (!senderId || !recipientId || !content) {
                log("Error: Please fill in Your ID, Recipient ID, and a message.");
                return;
            }

            const chatMessage = {
                senderId: senderId,
                recipientId: recipientId,
                content: content
            };

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            displayMessage(chatMessage);
            log(`Sent message to ${recipientId}: ${content}`);
            document.getElementById('messageContent').value = '';
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect(function() {
                    log("Disconnected.");
                    stompClient = null;
                });
            } else {
                log("Not connected.");
            }
        }
    </script>
</body>
</html>